#pragma once

#include "vivid.h"
#include <list>
#include <memory>
#include <unordered_map>
#include <functional>
#include "stage/stage.h"
#include "stage/stage_id.h"

class IStage;
class ISwitch;

///============================================================
/// ステージ全体を管理するクラス
/// ・ステージの生成／更新／描画／解放を一元管理
/// ・CSVから読み込んだデータを元にステージを配置
/// ・キャラクター、敵、弾との当たり判定を仲介
///============================================================
class CStageManager
{
public:
	//========================================================
	// シングルトンインスタンス取得
	//========================================================
	static CStageManager& GetInstance(void);

	//========================================================
	// 初期化処理
	// ステージ情報の読み込みと内部データの初期化
	//========================================================
	void Initialize(void);

	//========================================================
	// 更新処理
	// ステージ生成テーブルの更新およびステージ更新
	//========================================================
	void Update(void);

	//========================================================
	// 描画処理
	// 登録されているすべてのステージを描画
	//========================================================
	void Draw(void);

	//========================================================
	// 終了処理
	// ステージの解放およびメモリの後始末
	//========================================================
	void Finalize(void);

	//========================================================
	// ステージ生成
	// 指定したIDと座標からステージを生成する
	//========================================================
	void Create(STAGE_ID id, const vivid::Vector2& position);

	//========================================================
	// 全スイッチのON/OFF切り替え
	//========================================================
	void ToggleAllSwitch(void);

	//========================================================
	// 全スイッチがON状態かどうか取得
	//========================================================
	bool IsAllSwitchOn(void) const;

	//========================================================
	// スイッチに連動した床の移動方向変更
	//========================================================
	void MoveChange(ISwitch* sw);

private:
	//========================================================
	// コンストラクタ（シングルトン）
	//========================================================
	CStageManager(void);

	// コピー禁止
	CStageManager(const CStageManager& rhs) = delete;

	// デストラクタ
	~CStageManager(void) = default;

	// 代入禁止
	CStageManager operator=(const CStageManager& rhs) = delete;

	//========================================================
	// CSVからステージ配置データを読み込む
	//========================================================
	void DeployStage(void);

	//========================================================
	// ステージ生成テーブルの更新
	//（1フレームごとにステージを生成）
	//========================================================
	void UpdateStageTable(void);

	//========================================================
	// ステージ更新および各マネージャとの連携処理
	//========================================================
	void UpdateStage(void);

	// CSV読み込み用パラメータ
	enum class STAGE_TABLE_DATA_PARAM
	{
		ID,
		X,
		Y,
	};

	// ステージ配置データ
	struct STAGE_TABLE_DATA
	{
		STAGE_ID id;	// ステージID
		int	x;			// X座標
		int y;			// Y座標
	};

	//----------------------------------
	// Factory用
	//----------------------------------

	using CreateFunc = std::function<std::unique_ptr<IStage>()>;

	std::unordered_map<STAGE_ID, CreateFunc> m_CreateMap;

	// ステージ登録
	void RegisterStages(void);

	// ステージテーブルリスト型
	using STAGE_TABLE_LIST = std::list<STAGE_TABLE_DATA>;

	// ステージリスト型
	using STAGE_LIST = std::list<std::unique_ptr<IStage>>;

	//========================================================
	// メンバ変数
	//========================================================

	// 生成待ちステージテーブル
	STAGE_TABLE_LIST	m_StageTable;

	// 現在存在しているステージリスト
	STAGE_LIST			m_StageList;

	// すべてのスイッチをONにするフラグ
	bool				m_AllSwitchOn;
};
