#pragma once

#include "vivid.h"
#include <list>
#include <memory>
#include <unordered_map>
#include <functional>
#include "switch/switch_id.h"

class ISwitch;

///============================================================
/// スイッチ全体を管理するクラス
/// ・フロアスイッチやレバーなど、ステージ上のスイッチを一元管理
/// ・スイッチの生成／更新／描画／解放を担当
/// ・CSVから読み込んだ配置情報を元にステージ上に配置
///============================================================
class CSwitchManager
{
public:
	//========================================================
	// シングルトン取得
	//========================================================
	static CSwitchManager& GetInstance(void);

	//========================================================
	// 初期化
	// ・スイッチリストと生成テーブルの初期化
	// ・CSVからスイッチ配置情報を読み込み
	//========================================================
	void Initialize(void);

	//========================================================
	// 更新
	// ・スイッチ生成テーブルの更新
	// ・スイッチのUpdate呼び出し
	//========================================================
	void Update(void);

	//========================================================
	// 描画
	// 登録されているすべてのスイッチを描画
	//========================================================
	void Draw(void);

	//========================================================
	// 終了処理
	// 登録されている全スイッチのFinalize呼び出しとメモリ解放
	//========================================================
	void Finalize(void);

	//========================================================
	// スイッチ作成
	// 指定IDと座標に応じてスイッチを生成
	//========================================================
	void Create(SWITCH_ID id, const vivid::Vector2& position);

private:
	//========================================================
	// コンストラクタ / デストラクタ
	// シングルトンのためコピー禁止
	//========================================================
	CSwitchManager(void);
	CSwitchManager(const CSwitchManager& rhs) = delete;
	~CSwitchManager(void) = default;
	CSwitchManager operator=(const CSwitchManager& rhs) = delete;

	//========================================================
	// CSVからスイッチ配置データを読み込む
	//========================================================
	void DeploySwitch(void);

	//========================================================
	// スイッチ生成テーブルの更新
	// 1フレームにつき1つずつスイッチを生成
	//========================================================
	void UpdateSwitchTable(void);

	//========================================================
	// スイッチ更新処理
	// 各スイッチのUpdate呼び出しおよびキャラクターとの当たり判定
	//========================================================
	void UpdateSwitch(void);

	//========================================================
	// CSV読み込み用パラメータ
	//========================================================
	enum class SWITCH_TABLE_DATA_PARAM
	{
		ID,	// スイッチID
		X,	// X座標
		Y,	// Y座標
	};

	//========================================================
	// スイッチ配置データ
	//========================================================
	struct SWITCH_TABLE_DATA
	{
		SWITCH_ID id;	// スイッチ種別
		int x;			// X座標
		int y;			// Y座標
	};

	//----------------------------------
	// Factory用
	//----------------------------------

	using CreateFunc = std::function<std::unique_ptr<ISwitch>()>;

	std::unordered_map<SWITCH_ID, CreateFunc> m_CreateMap;

	// スイッチ登録
	void RegisterSwitches(void);

	//========================================================
	// 型定義
	//========================================================
	using SWITCH_TABLE_LIST = std::list<SWITCH_TABLE_DATA>;	// スイッチ生成テーブルリスト型
	using SWITCH_LIST = std::list<std::unique_ptr<ISwitch>>;// 登録済みスイッチリスト型

	//========================================================
	// メンバ変数
	//========================================================
	SWITCH_TABLE_LIST	m_SwitchTable;	// 生成待ちスイッチテーブル
	SWITCH_LIST			m_SwitchList;	// 現在存在しているスイッチリスト
};
