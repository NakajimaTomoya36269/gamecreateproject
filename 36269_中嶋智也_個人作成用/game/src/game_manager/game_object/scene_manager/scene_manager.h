#pragma once

#include "vivid.h"
#include "scene/scene.h"
#include "scene/scene_id.h"

class IScene;

//====================================================
// シーン管理クラス
// ・シーンの生成 / 破棄を一元管理
// ・フェード演出を含めた安全なシーン遷移を提供
// ・シングルトンとして全体からアクセス可能
//====================================================
class CSceneManager
{
public:
	//================================================
	// シングルトンインスタンスの取得
	//================================================
	static CSceneManager& GetInstance(void);

	//================================================
	// 初期化
	// ・初期シーンの設定
	// ・内部状態の初期化
	//================================================
	void Initialize(void);

	//================================================
	// 更新
	// ・シーン状態（フェード/更新/切替）に応じた
	//   ステートマシン制御
	//================================================
	void Update(void);

	//================================================
	// 描画
	// ・現在のシーン描画のみを担当
	// ・フェード描画は責務分離のため別関数
	//================================================
	void Draw(void);

	//================================================
	// 解放
	// ・管理中シーンの明示的破棄
	//================================================
	void Finalize(void);

	//================================================
	// シーン切り替え要求
	// ・即時切り替えは行わず、フェードアウト後に反映
	//================================================
	void ChangeScene(SCENE_ID next_scene);

	//================================================
	// シーンエフェクト描画
	// ・フェード用オーバーレイ描画
	// ・Draw()とは独立させ、描画順を制御可能にする
	//================================================
	void DrawSceneEffect(void);

private:
	//================================================
	// シーン生成（Factory的役割）
	// ・SCENE_ID → 具体的シーンクラス生成
	//================================================
	void Change(SCENE_ID id);

	//================================================
	// コンストラクタ
	// ・シングルトン専用のため private
	//================================================
	CSceneManager(void);

	// コピー禁止（シングルトン保証）
	CSceneManager(const CSceneManager& rhs) = delete;

	// デストラクタ
	~CSceneManager(void) = default;

	// 代入禁止（シングルトン保証）
	CSceneManager operator=(const CSceneManager& rhs) = delete;

	//================================================
	// フェードイン更新
	// ・アルファ値を減算し表示状態へ遷移
	//================================================
	void UpdateFadeIn(void);

	//================================================
	// 通常シーン更新
	// ・現在シーンの Update 呼び出し
	// ・シーン変更要求の監視
	//================================================
	void SceneUpdate(void);

	//================================================
	// フェードアウト更新
	// ・アルファ値を加算し非表示状態へ遷移
	//================================================
	void UpdateFadeOut(void);

	//================================================
	// シーン切り替え処理
	// ・旧シーン破棄
	// ・新シーン生成 & 初期化
	//================================================
	void SceneChange(void);

	//================================================
	// シーン管理用ステート
	// ・Update() 内の状態遷移を明確化
	//================================================
	enum class SCENE_STATE
	{
		FADEIN,			// フェードイン中
		SCENE_UPDATE,	// 通常更新中
		FADE_OUT,		// フェードアウト中
		SCENE_CHANGE,	// シーン切り替え処理中
	};

	//================================================
	// フェード関連定数
	//================================================
	static const int				m_fade_speed;		// 1フレームあたりのフェード変化量
	static const vivid::Vector2		m_fade_position;	// フェード描画位置（全画面想定）
	static const unsigned int		m_fade_color;		// フェード用カラー（α以外固定）
	static const int				m_min_fade_alpha;	// アルファ最小値
	static const int				m_max_fade_alpha;	// アルファ最大値

	//================================================
	// シーン管理用メンバ
	//================================================
	IScene* m_Scene;			// 現在のシーンインスタンス
	SCENE_ID	m_NextSceneID;		// 次に遷移するシーンID
	SCENE_ID	m_CurrentSceneID;	// 現在のシーンID
	SCENE_STATE	m_SceneState;		// シーン管理状態
	bool		m_ChangeScene;		// 明示的なシーン変更要求フラグ
	int			m_FadeAlpha;		// 現在のフェード用アルファ値
};
